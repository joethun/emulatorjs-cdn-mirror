<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="EmulatorJS - Web-based retro game emulator">
    <title>EmulatorJS</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/joethun/emulatorjs-cdn-mirror/Logo.svg" rel="icon">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            align-items: center;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            font-family: Inter, sans-serif;
            height: 100vh;
            justify-content: center;
            overflow: hidden;
        }

        #top {
            align-items: center;
            display: flex;
            flex-direction: column;
            margin: 5px;
        }

        .logo {
            height: 180px;
            width: 180px;
        }

        #box {
            align-items: center;
            background: #333;
            border-radius: .4em;
            border: 2px solid #555;
            color: #aaa;
            display: flex;
            flex-direction: column;
            font-size: 22px;
            font-weight: 700;
            height: 380px;
            justify-content: center;
            margin: 5px;
            max-height: 80%;
            max-width: 80%;
            overflow: hidden;
            padding: 10px;
            position: relative;
            text-align: center;
            transition: .2s;
            width: 640px;
        }

        #box:hover,
        #box[data-drag="true"] {
            border-color: #38f;
            color: #ddd;
        }

        #input {
            cursor: pointer;
            height: 100%;
            inset: 0;
            opacity: 0;
            position: absolute;
            width: 100%;
        }

        #display {
            height: 100%;
            width: 100%;
        }

        button,
        select {
            appearance: none;
            background: #444;
            border-radius: .4em;
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            font-family: Inter, sans-serif;
            font-size: 16px;
            font-weight: 700;
            margin: .5em;
            max-width: 100%;
            padding: .6em .4em;
            transition: .2s;
            width: 15em;
        }

        button:hover,
        select:hover {
            background: #666;
        }
    </style>
</head>

<body>
    <div id="top">
        <img src="https://cdn.jsdelivr.net/gh/joethun/emulatorjs-cdn-mirror/Logo.svg" alt="EmulatorJS Logo"
            class="logo">
        <h1>EmulatorJS</h1>
    </div>

    <div id="box">
        <input id="input" type="file">
        Drag ROM file or Click Here
    </div>

    <select id="version-select">
        <option value="stable">Stable</option>
        <option value="nightly">Nightly</option>
    </select>

    <script>
        (() => {
            'use strict';

            const CDN_BASE = 'https://cdn.jsdelivr.net/gh/joethun/emulatorjs-cdn-mirror';

            const CORE_MAPPINGS = {
                fds: "nes", nes: "nes", unif: "nes", unf: "nes",
                gb: "gb", gbc: "gbc", gba: "gba",
                smc: "snes", sfc: "snes", swc: "snes",
                vb: "vb", vboy: "vb",
                z64: "n64", n64: "n64",
                nds: "nds",
                sms: "segaMS", md: "segaMD", gen: "segaMD", smd: "segaMD", gg: "segaGG", "32x": "sega32x",
                cso: "psp", pbp: "psp",
                a26: "atari2600", a52: "atari5200", a78: "atari7800", lnx: "lynx", j64: "jaguar", jag: "jaguar",
                d64: "vice_x64", t64: "vice_x64", tap: "vice_x64", crt: "vice_x64",
                col: "coleco", cv: "coleco",
                pce: "pce", ngp: "ngp", ngc: "ngp", ws: "ws", wsc: "ws"
            };

            const SYSTEM_NAMES = {
                'Nintendo NES': 'nes', 'Nintendo GB': 'gb', 'Nintendo SNES': 'snes',
                'Nintendo VB': 'vb', 'Nintendo 64': 'n64', 'Nintendo GBC': 'gbc',
                'Nintendo GBA': 'gba', 'Nintendo DS': 'nds',
                'Sega MS': 'segaMS', 'Sega Gen/MD': 'segaMD', 'Sega GG': 'segaGG',
                'Sega CD': 'segaCD', 'Sega 32X': 'sega32x', 'Sega Saturn': 'segaSaturn',
                'Sony PS1': 'psx', 'Sony PSP': 'psp',
                'Atari 2600': 'atari2600', 'Atari 5200': 'atari5200', 'Atari 7800': 'atari7800',
                'Atari Lynx': 'lynx', 'Atari Jaguar': 'jaguar',
                'Panasonic 3DO': 'opera', 'Arcade (FBNeo)': 'arcade', 'Arcade (M.A.M.E)': 'mame2003_plus',
                'Microsoft DOS': 'dosbox_pure',
                'Commodore PET': 'vice_xpet', 'Commodore VIC20': 'vice_xvic', 'Commodore Amiga': 'amiga',
                'Commodore 64': 'vice_x64', 'Commodore 128': 'vice_x128', 'Commodore P/4': 'vice_xplus4',
                'ColecoVision': 'coleco',
                'NEC TurboGrafx-16': 'pce', 'NEC PC-FX': 'pcfx',
                'SNK NGP': 'ngp', 'Bandai WS': 'ws'
            };

            const els = {
                box: document.getElementById('box'),
                input: document.getElementById('input'),
                version: document.getElementById('version-select'),
                top: document.getElementById('top')
            };

            const getParams = () => new URLSearchParams(window.location.search);

            const detectCore = async (extension) => {
                const ext = extension.toLowerCase();
                if (CORE_MAPPINGS[ext]) {
                    return CORE_MAPPINGS[ext];
                }

                return new Promise((resolve) => {
                    const select = document.createElement('select');
                    const button = document.createElement('button');

                    Object.keys(SYSTEM_NAMES).sort().forEach(sysName => {
                        const option = document.createElement('option');
                        option.value = SYSTEM_NAMES[sysName];
                        option.textContent = sysName;
                        select.appendChild(option);
                    });

                    button.textContent = 'Load Game';
                    button.onclick = () => resolve(select.value);

                    els.box.innerHTML = '';
                    els.box.appendChild(select);
                    els.box.appendChild(button);
                });
            };

            const loadScript = (src) => {
                const script = document.createElement('script');
                script.src = src;
                document.body.appendChild(script);
            };

            const runEmulator = async (fileOrPath, isUpload = false) => {
                try {
                    let romUrl, romName, extension;

                    if (isUpload) {
                        const file = fileOrPath;
                        romUrl = file;
                        romName = file.name;
                    } else {
                        romUrl = `roms/${fileOrPath}`;
                        romName = fileOrPath;
                    }

                    const parts = romName.split('.');
                    extension = parts.pop();
                    const gameName = parts.join('.');

                    const core = await detectCore(extension);
                    [els.top, els.box, els.version].forEach(el => el?.remove());

                    const params = getParams();
                    const debug = params.get('debug') === 'true' || params.get('debug') === '1';
                    const threads = (params.get('threads') === 'true' || params.get('threads') === '1')
                        && !!window.SharedArrayBuffer;

                    const version = els.version.value;
                    const cdnPath = `${CDN_BASE}/${version}/`;

                    const displayDiv = document.createElement('div');
                    displayDiv.id = 'display';

                    const gameDiv = document.createElement('div');
                    gameDiv.id = 'game';
                    displayDiv.appendChild(gameDiv);
                    document.body.appendChild(displayDiv);

                    window.EJS_backgroundColor = '#000000';
                    window.EJS_player = '#game';
                    window.EJS_gameName = gameName;
                    window.EJS_biosUrl = '';
                    window.EJS_gameUrl = romUrl;
                    window.EJS_core = core;
                    window.EJS_pathtodata = cdnPath;
                    window.EJS_startOnLoaded = true;
                    window.EJS_DEBUG_XX = debug;
                    window.EJS_disableDatabases = true;
                    window.EJS_threads = threads;
                    window.EJS_Buttons = { exitEmulation: false, cacheManager: false };

                    loadScript(cdnPath + 'loader.js');

                } catch (error) {
                    console.error("Emulator setup failed:", error);
                    if (document.body.contains(els.box)) {
                        els.box.innerHTML = '<p style="color:#ff004c">Emulator Error. See console.</p>';
                    }
                }
            };

            const handleFileSelect = () => {
                if (els.input.files && els.input.files[0]) {
                    runEmulator(els.input.files[0], true);
                }
            };

            const handleDragOver = () => els.box.dataset.drag = "true";
            const handleDragLeave = () => delete els.box.dataset.drag;

            const params = getParams();
            const romParam = params.get('rom');
            if (romParam) {
                runEmulator(romParam, false);
            }

            els.input.addEventListener('change', handleFileSelect);
            els.box.addEventListener('dragover', handleDragOver);
            els.box.addEventListener('dragleave', handleDragLeave);

        })();
    </script>
</body>

</html>